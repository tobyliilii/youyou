<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>èªªå§!ä»Šå¤©èª°å¤©èƒ¡ğŸ€„ï¸</title>
  <!-- v5: water 44px, widen selects, remove per-person red packet; you bonus fixed +10 -->

  <style>
    :root{
      /* Dark Soft UI tokens */
      --bg:#0b111a;
      --surface:#0f1723;     /* card base */
      --surface2:#0d1520;    /* pressed */
      --text:#e7eefc;
      --muted:rgba(231,238,252,.65);

      --hi:rgba(255,255,255,.06);
      --lo:rgba(0,0,0,.58);
      --stroke:rgba(255,255,255,.07);

      --r-xl:26px;
      --r-lg:18px;
      --r-md:14px;
      --r-sm:12px;

      --shadow-raised:
        -10px -10px 22px var(--hi),
         10px  10px 22px var(--lo);

      --shadow-pressed:
        inset -6px -6px 12px rgba(255,255,255,.05),
        inset  6px  6px 12px rgba(0,0,0,.55);

      --shadow-small:
        -6px -6px 14px rgba(255,255,255,.045),
         6px  6px 14px rgba(0,0,0,.55);

      --accent:#4E7BFF;
      --accent2:#7CB0FF;

      --tableLine:rgba(255,255,255,.06);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(78,123,255,.16), transparent 60%),
        radial-gradient(900px 600px at 85% 25%, rgba(124,176,255,.10), transparent 55%),
        var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,"PingFang TC","Noto Sans TC",system-ui,sans-serif;
      -webkit-text-size-adjust:100%;
      padding-bottom:calc(18px + env(safe-area-inset-bottom));
    }

    .app{
      max-width:860px;
      margin:0 auto;
      padding:18px 16px 22px;
    }

    h1{ margin:8px 0 6px; font-size:22px; line-height:1.2; letter-spacing:.2px; }
    .muted{ color:var(--muted); font-size:13px; line-height:1.55; }

    /* ====== Soft UI surfaces ====== */
    .card{
      background:
        linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,0)),
        var(--surface);
      border:1px solid var(--stroke);
      border-radius:var(--r-xl);
      padding:24px;
      margin:14px 0;
      box-shadow:var(--shadow-raised);
    }

    /* smaller inner cards (per-round) */
    .roundCard{
      padding:18px;
      margin-top:12px;
      border-radius:20px;
      box-shadow:var(--shadow-small);
    }

    /* general form row */
    .row{ display:flex; gap:14px; flex-wrap:wrap; align-items:center; }
    .row > div{
      display:flex;
      flex-direction:column;
      justify-content:flex-end;
    }

    label{ font-size:12px; color:var(--muted); display:block; margin-bottom:8px; letter-spacing:.2px; }

    input,select,button{
      border-radius:var(--r-md);
      font-size:16px;
      color:var(--text);
      min-height:44px;
      outline:none;
    }

    /* pressed fields */
    input,select{
      padding:12px 14px;
      border:1px solid rgba(255,255,255,.06);
      background:var(--surface2);
      box-shadow:var(--shadow-pressed);
    }
    input[type="number"], input[type="text"]{ width:160px; }

    /* buttons (raised) */
    button{
      cursor:pointer;
      background:var(--surface);
      border:1px solid rgba(255,255,255,.09);
      box-shadow:var(--shadow-raised);
      font-weight:800;
      padding:0 16px;
      transition:transform .08s ease, box-shadow .12s ease, filter .12s ease;
    }
    button:hover{ filter:brightness(1.06); }
    button:active{
      transform: translateY(1px);
      box-shadow:var(--shadow-pressed);
    }

    /* secondary/ghost buttons */
    .resetBtn,
    #clearRoundsBtn,
    .roundHeader button{
      background:transparent;
      box-shadow:none;
      border:1px solid rgba(255,255,255,.12);
    }
    .resetBtn:hover,
    #clearRoundsBtn:hover,
    .roundHeader button:hover{
      filter:none;
      background:rgba(255,255,255,.04);
    }
    .resetBtn:active,
    #clearRoundsBtn:active,
    .roundHeader button:active{
      transform: translateY(1px);
      box-shadow:var(--shadow-pressed);
      background:rgba(255,255,255,.02);
    }

    /* primary CTA (è¨˜éŒ„æœ¬å±€) */
    #addRoundBtn{
      background: linear-gradient(180deg, rgba(124,176,255,.24), rgba(78,123,255,.18)), var(--surface);
      border-color: rgba(78,123,255,.35);
    }

    /* Tables: flat, clean */
    table{ width:100%; border-collapse:collapse; margin-top:12px; }
    th,td{
      border-bottom:1px solid var(--tableLine);
      padding:12px 8px;
      text-align:left;
      vertical-align:top;
    }
    th{ font-size:13px; color:var(--muted); font-weight:800; }
    tbody tr:hover{ background:rgba(255,255,255,.03); }

    .warn{ color:#ff6b6b; font-size:13px; margin-top:10px; }
    .ok{ color:#3ddc84; font-size:13px; margin-top:10px; }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace; }

    .badge{
      display:inline-block;
      padding:2px 10px;
      border-radius:999px;
      font-size:12px;
      background:rgba(255,214,102,.10);
      color:#ffd666;
      border:1px solid rgba(255,214,102,.18);
      margin-left:8px;
      line-height:1.7;
      vertical-align:middle;
      box-shadow: -6px -6px 12px rgba(255,255,255,.04), 6px 6px 12px rgba(0,0,0,.45);
    }

    .roundHeader{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
    }
    .roundTitle{ font-size:14px; line-height:1.4; }
    .roundLines{
      margin-top:12px;
      font-size:13px;
      line-height:1.6;
      word-break:break-word;
    }
    .roundHeader button{
      height:40px;
      line-height:40px;
      padding:0 12px;
      border-radius:14px;
      font-size:14px;
      white-space:nowrap;
    }

    .formRow{ align-items:flex-end; }

    /* ===== Names area ===== */
    .namesHeader{
      display:grid;
      grid-template-columns:1fr auto;
      gap:12px;
      align-items:end;
    }

    #namesRow.namesGrid{
      display:grid;
      grid-template-columns:repeat(4, minmax(0, 1fr));
      gap:14px !important;
      align-items:stretch;
    }

    #namesRow.namesGrid > div{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }

    #namesRow.namesGrid input{
      width:100%;
      text-align:center;
      border-radius:18px;
      padding:16px 14px;
      background:var(--surface2);
      border:1px solid rgba(255,255,255,.06);
      box-shadow:var(--shadow-pressed);
    }

    /* ===== Stepper (Water) ===== */
    .stepper{
      display:flex;
      align-items:center;
      gap:10px;
      padding:6px;
      border-radius:18px;
      background:var(--surface2);
      border:1px solid rgba(255,255,255,.06);
      box-shadow:var(--shadow-pressed);
    }

    /* center 0 */
    .stepper input[type="number"]{
      height:44px;
      padding:0;
      text-align:center;
      line-height:44px;
      width:56px !important;
      min-width:56px;
      max-width:56px;
      flex:0 0 auto;
      background:transparent;
      border:0;
      box-shadow:none;
    }

    .stepper button{
      width:44px;
      height:44px;
      padding:0;
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
      border-radius:16px;
      background:var(--surface);
      border:1px solid rgba(255,255,255,.08);
      box-shadow:var(--shadow-small);
    }
    .stepper button:active{ box-shadow:var(--shadow-pressed); }


    /* ===== Segmented (æ¸¸é‡‘ ç„¡/æœ‰) ===== */
    .sr-only{
      position:absolute !important;
      width:1px; height:1px;
      padding:0; margin:-1px;
      overflow:hidden;
      clip:rect(0,0,0,0);
      white-space:nowrap;
      border:0;
    }

    .segmented{
      display:flex;
      gap:6px;
      padding:6px;
      border-radius:18px;
      background:var(--surface2);
      border:1px solid rgba(255,255,255,.06);
      box-shadow:var(--shadow-pressed);
      min-height:44px;
    }

    .seg-btn{
      flex:1 1 0;
      height:44px;
      border-radius:14px;
      border:1px solid transparent;
      background:transparent;
      color:var(--muted);
      font-weight:900;
      letter-spacing:.2px;
      box-shadow:none;
      padding:0 14px;
      transition:filter .12s ease, transform .08s ease, box-shadow .12s ease, color .12s ease, background .12s ease;
    }

    .seg-btn.is-active{
      color:var(--text);
      background:
        linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,0)),
        var(--surface);
      border-color: rgba(255,255,255,.08);
      box-shadow: var(--shadow-small);
    }

    .segmented.is-disabled{
      opacity:.6;
      pointer-events:none;
    }

    /* ===== Select arrow (white) ===== */
    select{
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
      background-image:url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'>\
<path fill='white' fill-opacity='0.85' d='M6 9l6 6 6-6'/>\
</svg>");
      background-repeat:no-repeat;
      background-size:16px;
      background-position:right 12px center;
      padding-right:44px;
      text-align:center;
      text-align-last:center;
    }

    /* ===== Mobile ===== */
    @media (max-width:520px){
      .card{ padding:20px; }
      .namesHeader{
        grid-template-columns:1fr;
        gap:12px;
        align-items:stretch;
      }
      #namesRow.namesGrid{
        grid-template-columns:repeat(2, minmax(0, 1fr));
        gap:12px !important;
      }
      #resetBtn{ width:100%; justify-self:stretch; }
    }

    /* Desktop: remove number spinner ONLY for waterInput */
    @media (min-width:521px){
      #waterInput::-webkit-inner-spin-button,
      #waterInput::-webkit-outer-spin-button{
        -webkit-appearance:none;
        margin:0;
      }
      #waterInput{ -moz-appearance:textfield; }
    }

    button, select, input{ touch-action: manipulation; }

/* ===== v2 UI refinements ===== */
/* lock all controls to 44px visually */
button, select, input {
  height: 44px !important;
  line-height: 44px;
}

/* reset -> swap (secondary) */
#resetBtn{
  opacity: .55;
}

/* water compact */
.stepper{
  min-width: 120px;
}
#waterInput{
  width: 56px;
}

/* CTA grow */
#addRoundBtn{
  flex: 1;
}

/* segmented contrast */
.seg-btn{
  opacity:.45;
}
.seg-btn.is-active{
  opacity:1;
}


/* ===== v3 refinements (Second row alignment & hierarchy) ===== */

/* 1) True visual 44px baseline: use flex centering, fix select padding/line-height */
select, button, input{
  height:44px !important;
}
select{
  padding:0 14px !important;
  line-height:44px !important;
}
button{
  line-height:44px !important;
  padding:0 18px !important;
}
input{
  line-height:44px !important;
  padding:0 12px !important;
}

/* 2) Labels: bring back readable contrast (not too loud) */
.formRow label{
  color: rgba(231,238,252,.65) !important;
  margin-bottom:6px !important;
}

/* 3) Second row layout: keep tools compact, let CTA take remaining space */
.formRow > div{ min-width: unset !important; }
.formRow > div:not(:last-child){ flex:0 0 auto !important; }
.formRow > div:last-child{
  flex:1 1 320px !important;
  min-width: 240px !important;
}
#addRoundBtn{ width:100% !important; }

/* 4) Water: compact tool size */
.stepper{
  width:132px !important;
  flex:0 0 132px !important;
  height:44px !important;
}
.stepper button{
  width:44px !important;
  height:44px !important;
  padding:0 !important;
}
#waterInput{
  width:44px !important;
  padding:0 !important;
  text-align:center !important;
}

/* 5) Segmented: align height and make inactive darker */
.segmented{
  height:44px !important;
  align-items:center !important;
}
.seg-btn{ opacity:.32 !important; }
.seg-btn.is-active{ opacity:1 !important; }


/* ===== v4: single-row flow ===== */
.formRow{
  flex-wrap: nowrap !important;
  align-items: center !important;
}

/* remove vertical label space in row */
.formRow label{
  margin-bottom:2px !important;
  font-size:11px !important;
}

/* keep all controls inline */
.formRow > div{
  flex:0 0 auto !important;
}

/* water inline compact */
.stepper{
  width:120px !important;
}

/* CTA as sentence end */
.formRow > div:last-child{
  flex:1 1 auto !important;
}
#addRoundBtn{
  width:100% !important;
}


/* ===== v5: refinements (water to 44px rectangle, widen key selects) ===== */

/* Water: make it a true 44px rectangle like other inputs */
.stepper{
  padding:0 !important;
  height:44px !important;
  border-radius:14px !important;
  width:160px !important;         /* v5: rectangle width */
  flex:0 0 160px !important;
}
.stepper button{
  width:44px !important;
  height:44px !important;
  border-radius:12px !important;
}
#waterInput{
  width:72px !important;          /* give the number a bit more breathing room */
  min-width:72px !important;
  max-width:72px !important;
  height:44px !important;
}

/* Key selects: prevent text/arrow overlap */
#dealerSel, #winnerSel, #typeSel{
  min-width:170px !important;
  width:170px !important;
}

/* Since we removed ç´…åŒ…æ¬„ä½, keep second row strictly single-line */
#youWhoWrap{ min-width:170px !important; }


/* ===== v5.1: align with agreed visual ===== */

/* Desktop: keep the form inputs on a single baseline without wrapping */
@media (min-width: 980px){
  .formRow{ flex-wrap:nowrap !important; }
}

/* Water stepper: ensure total height is 44 (include padding/border) */
.stepper, .stepper button, #waterInput{
  box-sizing:border-box !important;
}
.stepper{
  padding:0 !important;
  height:44px !important;
  min-height:44px !important;
  border-radius:14px !important;
  width:150px !important;
  flex:0 0 150px !important;
  gap:0 !important;
}
.stepper button{
  width:44px !important;
  height:44px !important;
  border-radius:12px !important;
}
#waterInput{
  height:44px !important;
  width:62px !important;
  min-width:62px !important;
  max-width:62px !important;
}

/* Read-only pill for æ¸¸é‡‘ */
.pill{
  transition: transform .12s ease, filter .12s ease;

  display:flex;
  align-items:center;
  justify-content:center;
  height:44px;
  min-height:44px;
  padding:0 16px;
  border-radius:18px;
  background:var(--surface2);
  border:1px solid rgba(255,255,255,.06);
  box-shadow:var(--shadow-pressed);
  color:var(--text);
  font-weight:700;
  letter-spacing:.02em;
  min-width:92px;
}
.pill.is-on{ filter:brightness(1.08); }

</style>
</head>

<body>
  <div class="app">
    <h1>èªªå§!ä»Šå¤©èª°å¤©èƒ¡ğŸ€„ï¸</h1>

    <div class="card">
      <div class="namesHeader">
        <div id="namesRow" class="namesGrid"></div>
        <button id="resetBtn" class="resetBtn">æ›äºº</button>
      </div>
    </div>

    <div class="card">
      <div class="row formRow">
        <div>
          <label>èŠå®¶</label>
          <select id="dealerSel"></select>
        </div>

        <div>
          <label>è´å®¶</label>
          <select id="winnerSel"></select>
        </div>

        <div>
          <label>è´æ³•</label>
          <select id="typeSel">
            <option value="dao">èƒ¡ç‰Œ</option>
            <option value="zimo">è‡ªæ‘¸</option>
            <option value="danyou">å–®æ¸¸</option>
            <option value="shuangyou">é›™æ¸¸</option>
          </select>
        </div>

        <div>
          <label>æ°´</label>
          <div class="stepper">
            <button type="button" id="waterMinus">âˆ’</button>
            <input id="waterInput" type="number" value="0" min="0" max="12" inputmode="numeric" />
            <button type="button" id="waterPlus">ï¼‹</button>
          </div>
        </div>

        <div>
          <label>æ¸¸é‡‘</label>

          <!-- v5.1: read-only indicator (auto from è´æ³•) -->
          <div id="youPill" class="pill" aria-label="æ¸¸é‡‘ç‹€æ…‹">ç„¡</div>

          <!-- Keep the original select for logic/accessibility (hidden) -->
          <select id="youSel" class="sr-only" aria-hidden="true" tabindex="-1">
            <option value="none" selected>ç„¡</option>
            <option value="yes">æœ‰</option>
          </select>
        </div>

        <div id="youWhoWrap" style="display:none;">
          <label>æ¸¸é‡‘è€…</label>
          <select id="youWhoSel"></select>
        </div>

        <div>
          <label>&nbsp;</label>
          <button id="addRoundBtn">è¨˜éŒ„æœ¬å±€</button>
        </div>
      </div>
    </div>

    <div class="card">
      <strong>æœ¬å±€ç´€éŒ„</strong>
      <div id="roundList" style="margin-top:10px;"></div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between;">
        <div><strong>ç¸½è¨ˆï¼ˆæ°´è¡¨ï¼‰</strong></div>
        <div><button id="clearRoundsBtn">æ¸…ç©ºå…¨éƒ¨å±€æ•¸</button></div>
      </div>
      <div id="totalsArea"></div>
      <div style="margin-top:12px;"><strong>è½‰å¸³æ¸…å–®</strong></div>
      <div id="transfersArea"></div>
    </div>
  </div>

<script>
  const $ = (id) => document.getElementById(id);

  const LOOKUP = {
    dao: {
      0:{åº„:16, å¹³:8},  1:{åº„:17, å¹³:9},  2:{åº„:18, å¹³:10}, 3:{åº„:19, å¹³:11},
      4:{åº„:20, å¹³:12}, 5:{åº„:21, å¹³:13}, 6:{åº„:22, å¹³:14}, 7:{åº„:23, å¹³:15},
      8:{åº„:24, å¹³:16}, 9:{åº„:25, å¹³:17}, 10:{åº„:26, å¹³:18}, 11:{åº„:27, å¹³:19}, 12:{åº„:28, å¹³:20}
    },
    zimo: {
      0:{åº„:32, å¹³:16}, 1:{åº„:34, å¹³:18}, 2:{åº„:36, å¹³:20}, 3:{åº„:38, å¹³:22},
      4:{åº„:40, å¹³:24}, 5:{åº„:42, å¹³:26}, 6:{åº„:44, å¹³:28}, 7:{åº„:46, å¹³:30},
      8:{åº„:48, å¹³:32}, 9:{åº„:50, å¹³:34}, 10:{åº„:52, å¹³:36}, 11:{åº„:54, å¹³:38}, 12:{åº„:56, å¹³:40}
    },
    danyou: {
      1:{åº„:68, å¹³:36}, 2:{åº„:72, å¹³:40}, 3:{åº„:76, å¹³:44}, 4:{åº„:80, å¹³:48},
      5:{åº„:84, å¹³:52}, 6:{åº„:88, å¹³:56}, 7:{åº„:92, å¹³:60}, 8:{åº„:96, å¹³:64},
      9:{åº„:100, å¹³:68}, 10:{åº„:104, å¹³:72}, 11:{åº„:108, å¹³:76}, 12:{åº„:112, å¹³:80}
    },
    shuangyou: {
      1:{åº„:136, å¹³:72}, 2:{åº„:144, å¹³:80}, 3:{åº„:152, å¹³:88}, 4:{åº„:160, å¹³:96},
      5:{åº„:168, å¹³:104}, 6:{åº„:176, å¹³:112}, 7:{åº„:184, å¹³:120}, 8:{åº„:192, å¹³:128},
      9:{åº„:200, å¹³:136}, 10:{åº„:208, å¹³:144}, 11:{åº„:216, å¹³:152}, 12:{åº„:224, å¹³:160}
    }
  };

  let players = ["A","B","C","D"];
  let rounds = [];
  let youForcedByType = false;

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, (c)=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
  }
  function fmtMoney(x){
    const n = Math.round((x + Number.EPSILON) * 100) / 100;
    return n.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:2});
  }
  function buildOptions(sel){
    sel.innerHTML = players.map((p,i)=>`<option value="${i}">${escapeHtml(p)}</option>`).join("");
  }

  function renderNames(){
    if (!Array.isArray(players) || players.length !== 4) players = ["A","B","C","D"];
    $("namesRow").innerHTML = players.map((p,i)=>`
      <div>
        <label>ç©å®¶ ${i+1}</label>
        <input type="text" value="${escapeHtml(p)}" data-name="${i}">
      </div>
    `).join("");

    document.querySelectorAll("[data-name]").forEach(inp=>{
      inp.addEventListener("input",(e)=>{
        const i = Number(e.target.dataset.name);
        players[i] = e.target.value || `ç©å®¶${i+1}`;
        renderSelectors();
        renderAll();
      });
    });
  }

  function toggleYouUI(){
    const hasYou = $("youSel").value === "yes";
    $("youWhoWrap").style.display = hasYou ? "flex" : "none";
    if (hasYou) {
      if (!$("youWhoSel").value) $("youWhoSel").value = $("winnerSel").value;
    }
    syncYouSegmented();
    syncYouSegmentedDisabled();
}


  // ===== Segmented control for æ¸¸é‡‘ (ç„¡/æœ‰) =====
  function syncYouSegmented(){
    const seg = $("youSeg");
    if (!seg) return;
    const v = $("youSel").value;
    seg.querySelectorAll(".seg-btn").forEach(btn=>{
      const active = (btn.dataset.value === v);
      btn.classList.toggle("is-active", active);
      btn.setAttribute("aria-selected", active ? "true" : "false");
    });
  }

  function syncYouSegmentedDisabled(){
    const seg = $("youSeg");
    if (!seg) return;
    seg.classList.toggle("is-disabled", !!$("youSel").disabled);
  }


  function updateYouPill(){
    const pill = $("youPill");
    if (!pill) return;
    const v = $("youSel")?.value;
    pill.textContent = (v === "yes") ? "æœ‰" : "ç„¡";
    pill.classList.toggle("is-on", v === "yes");
  }

  function setYouValue(v){
    const sel = $("youSel");
    if (!sel) return;
    if (sel.value === v) return;
    sel.value = v;
    // trigger existing change handlers
    sel.dispatchEvent(new Event("change", { bubbles: true }));
    updateYouPill();
  }

  function initYouSegmented(){
    const seg = $("youSeg");
    if (!seg) return;
    seg.querySelectorAll(".seg-btn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        if ($("youSel").disabled) return;
        setYouValue(btn.dataset.value);
      });
    });
    syncYouSegmented();
    syncYouSegmentedDisabled();
  }


  function renderSelectors(){
    buildOptions($("dealerSel"));
    buildOptions($("winnerSel"));
    buildOptions($("youWhoSel"));

    $("dealerSel").value = "0";
    $("winnerSel").value = "0";
    $("youWhoSel").value = $("winnerSel").value;

    toggleYouUI();
  }

  function lookupAmount({ type, water, winnerIsDealer }){
  const row = LOOKUP[type]?.[water];
  if (!row) return null;
  return winnerIsDealer ? row["åº„"] : row["å¹³"];
}

  function typeLabel(t){
    return ({dao:"åˆ°ï¼ˆèƒ¡ç‰Œï¼‰", zimo:"è‡ªæ‘¸", danyou:"å–®æ¸¸", shuangyou:"é›™æ¸¸"}[t] || t);
  }

  function syncWaterByType(){
  const type = $("typeSel").value;
  const input = $("waterInput");

  let v = Number(input.value || 0);
  if (!Number.isFinite(v)) v = 0;

  v = Math.max(0, Math.min(12, v));
  if ((type === "danyou" || type === "shuangyou") && v < 1) v = 1;
  input.value = String(v);

  // --- å–®æ¸¸/é›™æ¸¸ï¼šè‡ªå‹•é–‹å•Ÿæ¸¸é‡‘ ---
  const isYouType = (type === "danyou" || type === "shuangyou");

  if (isYouType) {
    // å¼·åˆ¶åˆ‡åˆ°ã€Œæœ‰ã€
    if ($("youSel").value !== "yes") $("youSel").value = "yes";

    youForcedByType = true;
$("youWhoSel").value = $("winnerSel").value;

    // é¿å…æ‰‹æ»‘æ”¹å›ã€Œç„¡ã€
    $("youSel").disabled = true;
  } else {
    // å¾å–®æ¸¸/é›™æ¸¸åˆ‡å›ä¾†ï¼šè§£é™¤å¼·åˆ¶
    if (youForcedByType) {
      $("youSel").disabled = false;
      // ç­–ç•¥ Bï¼šä¿ç•™ä½¿ç”¨è€…ç›®å‰é¸æ“‡ï¼ˆä¸å‹• valueï¼‰
      youForcedByType = false;
    }
  }

  toggleYouUI();
  updateYouPill();
}

  function addRound(){
    const dealer = Number($("dealerSel").value);
    const winner = Number($("winnerSel").value);
    const type = $("typeSel").value;
    const water = Number($("waterInput").value);
    const scale = 1;

    if ((type === "danyou" || type === "shuangyou") && water === 0){
      alert("å–®æ¸¸/é›™æ¸¸çš„æ°´=0 åœ¨æ°´è¡¨æ˜¯ç„¡æ•ˆï¼ˆâ€”ï¼‰ã€‚è«‹é¸ 1ï½12ã€‚");
      return;
    }

    let lines = [];

    for (let i=0;i<players.length;i++){
      if (i === winner) continue;

      const raw = lookupAmount({
  type,
  water,
  winnerIsDealer: (winner === dealer)
});

      if (raw == null){
        alert("æŸ¥è¡¨å¤±æ•—ï¼šè«‹ç¢ºèªè´æ³•èˆ‡æ°´æ•¸æ˜¯å¦æœ‰æ•ˆã€‚");
        return;
      }
      const amount = raw * scale;
      lines.push({
        from:i,
        to:winner,
        amount,
        raw:`æŸ¥è¡¨ ${raw}`,
        role:(i===dealer ? "åº„" : "å¹³")
      });
    }

    if ($("youSel").value === "yes") {
      const youWho = Number($("youWhoSel").value);
      const youAmt = 10; // v5: fixed bonus, no manual input

      for (let i = 0; i < players.length; i++) {
        if (i === youWho) continue;
        lines.push({
          from: i,
          to: youWho,
          amount: youAmt,
          raw: `æ¸¸é‡‘ +${youAmt}`,
          role: "æ¸¸é‡‘"
        });
      }
    }

    rounds.push({dealer, winner, type, water, lines});
    $("youWhoSel").value = $("winnerSel").value;
    renderAll();
  }

  function removeRound(idx){
    rounds.splice(idx,1);
    renderAll();
  }
  window.removeRound = removeRound;

  function computeTotals(){
  const totals = Array(players.length).fill(0);
  const youRecvCount = Array(players.length).fill(0); // âœ… æ¯å±€æ¸¸é‡‘äº‹ä»¶æ¬¡æ•¸
  const youRecvAmt = Array(players.length).fill(0);   // âœ… æ¸¸é‡‘ç¸½é¡ï¼ˆç…§æ¨£åŠ ç¸½ï¼‰

  rounds.forEach(r=>{
    // é€™å±€å·²ç¶“å¹«å“ªäº›äººç®—éã€Œæ¸¸é‡‘äº‹ä»¶æ¬¡æ•¸ã€äº†ï¼ˆé¿å…åŒå±€ä¸‰ç­†è¢«ç®—ä¸‰æ¬¡ï¼‰
    const countedYouThisRound = new Set();

    r.lines.forEach(L=>{
      totals[L.from] -= L.amount;
      totals[L.to]   += L.amount;

      if (L.role === "æ¸¸é‡‘") {
        // é‡‘é¡ï¼šæ¯ç­†éƒ½åŠ ï¼ˆB/C/D å„ +10ï¼Œç¸½å…± +30ï¼‰
        youRecvAmt[L.to] += L.amount;

        // æ¬¡æ•¸ï¼šåŒä¸€å±€åŒä¸€å€‹æ”¶æ¬¾äººåªç®— 1 æ¬¡
        if (!countedYouThisRound.has(L.to)) {
          youRecvCount[L.to] += 1;
          countedYouThisRound.add(L.to);
        }
      }
    });
  });

  return { totals, youRecvCount, youRecvAmt };
}

  function settleTransfers(totals){
    const creditors = [];
    const debtors = [];
    totals.forEach((amt,i)=>{
      const a = Math.round(amt*100)/100;
      if (a > 0) creditors.push({i, amt:a});
      else if (a < 0) debtors.push({i, amt:-a});
    });

    const res = [];
    let ci=0, di=0;
    while(ci<creditors.length && di<debtors.length){
      const c = creditors[ci], d = debtors[di];
      const pay = Math.min(c.amt, d.amt);
      if (pay > 0.000001) res.push({from:d.i, to:c.i, amount:pay});
      c.amt -= pay; d.amt -= pay;
      if (c.amt <= 0.000001) ci++;
      if (d.amt <= 0.000001) di++;
    }
    return res;
  }

  function badgeIf(name, should){
    return should ? `${name}<span class="badge">ğŸŸ¡æ¸¸é‡‘</span>` : name;
  }

  function renderRoundList(){
    if (!rounds.length){
      $("roundList").innerHTML = `<div class="muted">å°šæœªè¨˜éŒ„å±€æ•¸ã€‚</div>`;
      return;
    }

    $("roundList").innerHTML = rounds.map((r,idx)=>{
      const youLine = r.lines.find(L => L.role === "æ¸¸é‡‘");
      const youWho = youLine ? youLine.to : null;

      // èŠå®¶æ°¸é ä¸é¡¯ç¤ºæ¸¸é‡‘ badgeï¼ˆåªé¡¯ç¤ºåå­—ï¼‰
const dealerName = escapeHtml(players[r.dealer]);

// badge æ°¸é åªåœ¨è´å®¶æ—é‚Šé¡¯ç¤ºï¼ˆè‹¥æ¸¸é‡‘è€…=è´å®¶æ‰é¡¯ç¤ºï¼‰
const winnerName = badgeIf(escapeHtml(players[r.winner]), youWho === r.winner);

      const title = `ç¬¬ ${idx+1} å±€ï½œèŠï¼š${dealerName}ï½œè´ï¼š${winnerName}ï½œ${typeLabel(r.type)}ï½œ${r.water} æ°´`;

      const lines = r.lines.map(L=>{
        return `${escapeHtml(players[L.from])}ï¼ˆ${escapeHtml(L.role)}ï¼‰ â†’ ${escapeHtml(players[L.to])}ï¼š${fmtMoney(L.amount)} <span class="muted">(${escapeHtml(L.raw)})</span>`;
      }).join("<br>");

      return `
        <div class="card roundCard">
          <div class="roundHeader">
            <div class="roundTitle"><strong>${title}</strong></div>
            <button onclick="removeRound(${idx})">åˆªé™¤æœ¬å±€</button>
          </div>
          <div class="mono roundLines">${lines}</div>
        </div>
      `;
    }).join("");
  }

  function renderTotalsAndTransfers(){
    const { totals, youRecvCount, youRecvAmt } = computeTotals();
    const sum = Math.round(totals.reduce((a,b)=>a+b,0)*100)/100;

    const totalsRows = totals.map((amt,i)=>{
  const hasYou = youRecvCount[i] > 0 && Math.abs(youRecvAmt[i]) > 0.000001;

  const youTag = hasYou
    ? ` <span class="muted">ï¼ˆå«æ¸¸é‡‘ +${fmtMoney(youRecvAmt[i])} / ${youRecvCount[i]}æ¬¡ï¼‰</span>`
    : "";

  return `
    <tr>
      <td>${escapeHtml(players[i])}</td>
      <td class="mono">${amt>=0?"+":""}${fmtMoney(amt)}${youTag}</td>
    </tr>
  `;
}).join("");

    $("totalsArea").innerHTML = `
      <div class="${Math.abs(sum) < 0.01 ? "ok" : "warn"}">
        ${Math.abs(sum) < 0.01 ? "ç¸½å’Œ OKï¼ˆæ”¶æ”¯å¹³è¡¡ï¼‰" : `è­¦å‘Šï¼šç¸½å’Œä¸ç‚º 0ï¼ˆç›®å‰ ${fmtMoney(sum)}ï¼‰`}
      </div>
      <table>
        <thead><tr><th>ç©å®¶</th><th>ç¸½è¼¸è´ï¼ˆé‡‘é¡ï¼‰</th></tr></thead>
        <tbody>${totalsRows}</tbody>
      </table>
    `;

    const transfers = settleTransfers(totals);
    if (!transfers.length){
      $("transfersArea").innerHTML = `<div class="muted">ç›®å‰ç„¡éœ€è½‰å¸³ï¼ˆæˆ–å°šæœªè¨˜éŒ„å±€æ•¸ï¼‰ã€‚</div>`;
      return;
    }

    $("transfersArea").innerHTML = `
      <table>
        <thead><tr><th>èª°ä»˜</th><th></th><th>ä»˜çµ¦èª°</th><th>é‡‘é¡</th></tr></thead>
        <tbody>
          ${transfers.map(t=>`
            <tr>
              <td>${escapeHtml(players[t.from])}</td>
              <td>â†’</td>
              <td>${escapeHtml(players[t.to])}</td>
              <td class="mono">${fmtMoney(t.amount)}</td>
            </tr>
          `).join("")}
        </tbody>
      </table>
    `;
  }

  function renderAll(){
    renderRoundList();
    renderTotalsAndTransfers();
  }

  function resetAll(){
    rounds = [];
    renderSelectors();
    renderAll();
    syncWaterByType();
    toggleYouUI();
  }

  $("typeSel").addEventListener("change", syncWaterByType);

  $("waterMinus").addEventListener("click", ()=>{
    let v = Number($("waterInput").value || 0);
    v = Math.max(0, v - 1);
    $("waterInput").value = v;
    syncWaterByType();
  });
  $("waterPlus").addEventListener("click", ()=>{
    let v = Number($("waterInput").value || 0);
    v = Math.min(12, v + 1);
    $("waterInput").value = v;
    syncWaterByType();
  });
  $("waterInput").addEventListener("input", syncWaterByType);
  $("waterInput").addEventListener("blur", syncWaterByType);

  $("resetBtn").addEventListener("click", resetAll);
  $("addRoundBtn").addEventListener("click", addRound);
  $("clearRoundsBtn").addEventListener("click", ()=>{ rounds=[]; renderAll(); });

  $("youSel").addEventListener("change", toggleYouUI);
  $("winnerSel").addEventListener("change", ()=>{
    $("youWhoSel").value = $("winnerSel").value;
  });

  renderNames();
  renderSelectors();
  initYouSegmented();
  updateYouPill();
  syncWaterByType();
  toggleYouUI();
  renderAll();
</script>
</body>
</html>
